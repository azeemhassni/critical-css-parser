{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["/**\n * Copyright (c) 2019, Anton Babakhin\n * All rights reserved. (MIT Licensed)\n * \n * critical-css-parser\n */\n\nconst httpServer = require('http-server');\nconst puppeteer = require('puppeteer');\nconst dropcss = require('dropcss');\nconst { get } = require('axios');\n\n/**\n * Receive critical and other CSS\n * @param  {object} options Options\n * @return {Promise<{ critical: string, rest: string }>} Result object with critical css and rest css\n */\nasync function criticalCSSParser( options ) {\n  \tif( options.type === 'HTML' ) {\n\t\tconst { html = '', css = '', whitelist = /#fooBazBarAboveTheFold8917/, minify = false } = options;\n\t\tconst { puppeteerArgs } = options;\n\t\tconst browser = await puppeteer.launch({\n\t\t\targs: puppeteerArgs\n\t\t});\n\n\t\t// Puppeteer page with desktop version\n\t\tconst page = await browser.newPage();\n\t\tawait page.setDefaultNavigationTimeout( 60000 );\n\t\tawait page.setContent(html, { waitUntil: 'networkidle2'\t});\n\t\tawait page.addStyleTag({ content: css });\n\t\tawait page.setViewport({ width: 1920, height: 1200 });\n\n\t\t// Puppeteer page with mobile version\n\t\tconst page2 = await browser.newPage();\n\t\tawait page2.setDefaultNavigationTimeout( 60000 );\n\t\tawait page2.setContent(html, { waitUntil: 'networkidle2' });\n\t\tawait page2.addStyleTag({ content: css });\n\t\tawait page2.setViewport({ width: 480, height: 650, isMobile: true, hasTouch: true });\n\t\t\n\t\tconst aboveTheFold = await aboveTheFoldHTML( page, 1200 );\n\t\tconst aboveTheFoldMob = await aboveTheFoldHTML( page2, 650 );\n\n\t\tawait browser.close();\n\n\t\tconst result = extract( aboveTheFold, aboveTheFoldMob, css, whitelist, minify );\n\t\treturn result;\n\n\t} else if( options.type === 'URL' ) {\n\t\tconst { URL = '', enableGoogleFonts = 0, whitelist = /#fooBazBarAboveTheFold8917/, minify = false } = options;\n\n\t\tconst { puppeteerArgs } = options;\n\t\tconst browser = await puppeteer.launch({\n\t\t\targs: puppeteerArgs\n\t\t});\n\n\n\t\t// Puppeteer page with desktop version\n\t\tconst page = await browser.newPage();\n\t\tawait page.setDefaultNavigationTimeout( 60000 );\n\t\tawait page.goto(URL, { waitUntil: 'networkidle2' });\t\t\n\t\tawait page.setViewport({ width: 1920, height: 1200 });\n\t\tlet styleHrefs = await page.$$eval('link[rel=stylesheet]', els => Array.from(els).map(s => s.href));\n\t\tif( !enableGoogleFonts ) {\n\t\t\tstyleHrefs = styleHrefs.filter( href => href.indexOf('fonts.googleapis.com') === -1 );\n\t\t}\n\n\t\t// Puppeteer page with mobile version\n\t\tconst page2 = await browser.newPage();\n\t\tawait page2.setDefaultNavigationTimeout( 60000 );\n\t\tawait page2.goto(URL, { waitUntil: 'networkidle2' });\t\t\n\t\tawait page2.setViewport({ width: 480, height: 650, isMobile: true, hasTouch: true }); \n\t\t\n\t\tconst aboveTheFold = await aboveTheFoldHTML( page, 1200 );\n\t\tconst aboveTheFoldMob = await aboveTheFoldHTML( page2, 650 );\n\n\t\tawait browser.close();\n\n\t\t// Concatenate all styles \n\t\tlet css = '';\n\t\tawait Promise.all(styleHrefs.map(async href => {\n\t\t\tlet { data } = await get(href);\n\t\t\tcss += data;\n\t\t}));\n\n\t\tconst result = extract( aboveTheFold, aboveTheFoldMob, css, whitelist, minify );\n\t\treturn result;\t\n\t\t\n\t} else if( options.type === 'localServer' ) {\n\t\tconst { entrypoint = '', filename = 'index.html', enableGoogleFonts = 0, whitelist = /#fooBazBarAboveTheFold8917/, minify = false } = options;\n\t\t\n\t\t// Create local server to open the page\n\t\tconst server = httpServer.createServer({root: entrypoint});\n\t\tserver.listen(6543);\n\n\t\tconst { puppeteerArgs } = options;\n\t\tconst browser = await puppeteer.launch({\n\t\t\targs: puppeteerArgs\n\t\t});\n\n\t\t// Puppeteer page with desktop version\n\t\tconst page = await browser.newPage();\n\t\tawait page.setDefaultNavigationTimeout( 60000 );\n\t\tawait page.goto(`http://127.0.0.1:6543/${filename}`, { waitUntil: 'networkidle2' });\t\t\n\t\tawait page.setViewport({ width: 1920, height: 1200 });\n\t\tlet styleHrefs = await page.$$eval('link[rel=stylesheet]', els => Array.from(els).map(s => s.href));\n\t\tif( !enableGoogleFonts ) {\n\t\t\tstyleHrefs = styleHrefs.filter( href => href.indexOf('fonts.googleapis.com') === -1 );\n\t\t}\n\n\t\t// Puppeteer page with mobile version\n\t\tconst page2 = await browser.newPage();\n\t\tawait page2.setDefaultNavigationTimeout( 60000 );\n\t\tawait page2.goto(`http://127.0.0.1:6543/${filename}`, { waitUntil: 'networkidle2' });\t\t\n\t\tawait page2.setViewport({ width: 480, height: 650, isMobile: true, hasTouch: true }); \n\t\t\n\t\tconst aboveTheFold = await aboveTheFoldHTML( page, 1200 );\n\t\tconst aboveTheFoldMob = await aboveTheFoldHTML( page2, 650 );\n\n\t\tawait browser.close();\n\n\t\t// Concatenate all styles \n\t\tlet css = '';\n\t\tawait Promise.all(styleHrefs.map(async href => {\n\t\t\tlet { data } = await get(href);\n\t\t\tcss += data;\n\t\t}));\n\n\t\tserver.close();\n\n\t\tconst result = extract( aboveTheFold, aboveTheFoldMob, css, whitelist, minify );\n\t\treturn result;\t\n\t}\n}\n\n/**\n * Receive above-the-fold HTML\n * @param  {object} page Page from Puppeteer\n * @param  {number} height Height of viewport \n * @return {Promise<string>} Result html\n */\nasync function aboveTheFoldHTML( page, height ) {\n\tawait page.$$eval('body *:not(script):not(style)', ( elems, height ) => {\n\t\tArray.from(elems).forEach(elem => {\t\t\t\n\t\t\tif( elem.getBoundingClientRect()['top'] + pageYOffset > height ) {\n\t\t\t\ttry {\n\t\t\t\t\t// Remove element below the fold\n\t\t\t\t\telem.remove();\n\t\t\t\t} catch( e ) {\n\t\t\t\t\tconsole.log(e);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}, height);\n\n\tconst html = await page.content();\n\treturn html;\n}\n\n/**\n * Extract critical and rest CSS from HTML\n * @param  {string} deskHTML HTML of desktop version\n * @param  {string} mobHTML HTML of mobile version\n * @param  {string} css CSS \n * @param  {RegExp} whitelist Regular Expression of needed tags \n * @return {Promise<{ critical: string, rest: string }>} Result object with critical css and rest css\n */\nfunction extract( deskHTML, mobHTML, css, whitelist, minify ) {\n\t// Receive above-the-fold css-selectors of desktop version\n\tlet resDesk = dropcss({\n\t\thtml: deskHTML,\n\t\tcss,\n\t\tshouldDrop: ( sel ) => {\n\t\t\tif ( whitelist.test( sel ) )\n\t\t\t\t\treturn false;\n\t\t\telse {\t\t\t\t\t\t\t\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t},\n\t});\n\n\t// Receive above-the-fold css-selectors of mobile version\n\tlet resMob = dropcss({\n\t\thtml: mobHTML,\n\t\tcss,\n\t\tshouldDrop: ( sel ) => {\n\t\t\tif ( whitelist.test( sel ) )\n\t\t\t\t\treturn false;\n\t\t\telse {\t\t\t\t\t\t\t\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t},\n\t});\n\n\tlet selectors = new Set();\n\tresDesk.sels.forEach( sel => selectors.add( sel ) );\n\tresMob.sels.forEach( sel => selectors.add( sel ) );\n\n\tlet above = dropcss({\n\t\thtml: '',\n\t\tcss,\n\t\tshouldDrop: sel => !selectors.has( sel ),\n\t});\n\n\tlet rest = dropcss({\n\t\thtml: '',\n\t\tcss,\n\t\tshouldDrop: sel => selectors.has( sel ),\n\t});\n\n\tif ( minify ) {\n\t\tconst csso = require('csso');\n\t\tabove.css = csso.minify( above.css ).css;\n\t\trest.css = csso.minify( rest.css ).css;\n\t}\n\n\treturn { critical: above.css, rest: rest.css };\n}\n\nmodule.exports = criticalCSSParser;\n"],"names":["aboveTheFoldHTML","page","height","$$eval","elems","Array","from","forEach","elem","getBoundingClientRect","pageYOffset","remove","e","console","log","content","httpServer","require","puppeteer","dropcss","extract","deskHTML","mobHTML","css","whitelist","minify","resDesk","html","shouldDrop","sel","test","resMob","selectors","Set","sels","add","above","has","rest","csso","critical","module","exports","options","type","launch","args","browser","newPage","setDefaultNavigationTimeout","setContent","waitUntil","addStyleTag","setViewport","width","page2","isMobile","hasTouch","aboveTheFold","aboveTheFoldMob","close","goto","URL","els","map","s","href","styleHrefs","enableGoogleFonts","filter","indexOf","Promise","all","get","server","createServer","root","entrypoint","listen","filename"],"mappings":"IA4IeA,WAAkBC,EAAMC,8BAChCD,EAAKE,OAAO,yCAAmCC,EAAOF,GAC3DG,MAAMC,KAAKF,GAAOG,iBAAQC,MACrBA,EAAKC,wBAAL,IAAsCC,YAAcR,MAGtDM,EAAKG,SACJ,MAAOC,GACRC,QAAQC,IAAIF,OAIbV,2CAEgBD,EAAKc,iDAnJnBC,EAAaC,QAAQ,eACrBC,EAAYD,QAAQ,aACpBE,EAAUF,QAAQ,aACRA,QAAQ,aA4JxB,SAASG,EAASC,EAAUC,EAASC,EAAKC,EAAWC,OAEhDC,EAAUP,EAAQ,CACrBQ,KAAMN,MACNE,EACAK,oBAAcC,UACRL,EAAUM,KAAMD,MASnBE,EAASZ,EAAQ,CACpBQ,KAAML,MACNC,EACAK,oBAAcC,UACRL,EAAUM,KAAMD,MAQnBG,EAAY,IAAIC,IACpBP,EAAQQ,KAAK3B,iBAASsB,UAAOG,EAAUG,IAAKN,KAC5CE,EAAOG,KAAK3B,iBAASsB,UAAOG,EAAUG,IAAKN,SAEvCO,EAAQjB,EAAQ,CACnBQ,KAAM,OACNJ,EACAK,oBAAYC,UAAQG,EAAUK,IAAKR,MAGhCS,EAAOnB,EAAQ,CAClBQ,KAAM,OACNJ,EACAK,oBAAYC,UAAOG,EAAUK,IAAKR,SAG9BJ,EAAS,KACPc,EAAOtB,QAAQ,QACrBmB,EAAMb,IAAMgB,EAAKd,OAAQW,EAAMb,KAAMA,IACrCe,EAAKf,IAAMgB,EAAKd,OAAQa,EAAKf,KAAMA,UAG7B,CAAEiB,SAAUJ,EAAMb,IAAKe,KAAMA,EAAKf,KAG1CkB,OAAOC,iBAzM2BC,4CACV,SAAjBA,EAAQC,kCACE,+BAAU,qCAAgB,oEAAuC,mBAE1D1B,EAAU2B,OAAO,CACtCC,sCADKC,0BAKaA,EAAQC,yBAArB/C,0BACAA,EAAKgD,4BAA6B,6CAClChD,EAAKiD,WAAWvB,EAAM,CAAEwB,UAAW,yDACnClD,EAAKmD,YAAY,CAAErC,QAASQ,4CAC5BtB,EAAKoD,YAAY,CAAEC,MAAO,KAAMpD,OAAQ,+CAG1B6C,EAAQC,yBAAtBO,0BACAA,EAAMN,4BAA6B,6CACnCM,EAAML,WAAWvB,EAAM,CAAEwB,UAAW,yDACpCI,EAAMH,YAAY,CAAErC,QAASQ,4CAC7BgC,EAAMF,YAAY,CAAEC,MAAO,IAAKpD,OAAQ,IAAKsD,UAAU,EAAMC,UAAU,4CAElDzD,EAAkBC,EAAM,qBAA7CyD,0BACwB1D,EAAkBuD,EAAO,oBAAjDI,0BAEAZ,EAAQa,gCAECxC,EAASsC,EAAcC,EAAiBpC,EAAKC,EAAWC,oDAG5C,QAAjBkB,EAAQC,iCACJ,6CAAwB,oCAAe,oEAAuC,mBAGtE1B,EAAU2B,OAAO,CACtCC,sCADKC,0BAMaA,EAAQC,yBAArB/C,0BACAA,EAAKgD,4BAA6B,6CAClChD,EAAK4D,KAAKC,EAAK,CAAEX,UAAW,yDAC5BlD,EAAKoD,YAAY,CAAEC,MAAO,KAAMpD,OAAQ,+CACvBD,EAAKE,OAAO,gCAAwB4D,UAAO1D,MAAMC,KAAKyD,GAAKC,aAAIC,UAAKA,EAAEC,wBAAzFC,UACCC,IACJD,EAAaA,EAAWE,gBAAQH,UAAkD,IAA1CA,EAAKI,QAAQ,2CAIlCvB,EAAQC,yBAAtBO,0BACAA,EAAMN,4BAA6B,6CACnCM,EAAMM,KAAKC,EAAK,CAAEX,UAAW,yDAC7BI,EAAMF,YAAY,CAAEC,MAAO,IAAKpD,OAAQ,IAAKsD,UAAU,EAAMC,UAAU,4CAElDzD,EAAkBC,EAAM,qBAA7CyD,0BACwB1D,EAAkBuD,EAAO,oBAAjDI,0BAEAZ,EAAQa,6BAGVrC,EAAM,0BACJgD,QAAQC,IAAIL,EAAWH,aAAUE,8BACjBO,EAAIP,qBACzB3C,0EAGcH,EAASsC,EAAcC,EAAiBpC,EAAKC,EAAWC,oDAG5C,gBAAjBkB,EAAQC,wCACG,oCAAe,uDAAkC,oCAAe,6DAAuC,OAGtH8B,EAAS1D,EAAW2D,aAAa,CAACC,KAAMC,WAC9CH,EAAOI,OAAO,sBAGQ5D,EAAU2B,OAAO,CACtCC,sCADKC,0BAKaA,EAAQC,yBAArB/C,0BACAA,EAAKgD,4BAA6B,6CAClChD,EAAK4D,8BAA8BkB,EAAY,CAAE5B,UAAW,yDAC5DlD,EAAKoD,YAAY,CAAEC,MAAO,KAAMpD,OAAQ,+CACvBD,EAAKE,OAAO,gCAAwB4D,UAAO1D,MAAMC,KAAKyD,GAAKC,aAAIC,UAAKA,EAAEC,wBAAzFC,UACCC,IACJD,EAAaA,EAAWE,gBAAQH,UAAkD,IAA1CA,EAAKI,QAAQ,2CAIlCvB,EAAQC,yBAAtBO,0BACAA,EAAMN,4BAA6B,6CACnCM,EAAMM,8BAA8BkB,EAAY,CAAE5B,UAAW,yDAC7DI,EAAMF,YAAY,CAAEC,MAAO,IAAKpD,OAAQ,IAAKsD,UAAU,EAAMC,UAAU,4CAElDzD,EAAkBC,EAAM,qBAA7CyD,0BACwB1D,EAAkBuD,EAAO,oBAAjDI,0BAEAZ,EAAQa,6BAGVrC,EAAM,0BACJgD,QAAQC,IAAIL,EAAWH,aAAUE,8BACjBO,EAAIP,qBACzB3C,0EAGDmD,EAAOd,QAEQxC,EAASsC,EAAcC,EAAiBpC,EAAKC,EAAWC"}